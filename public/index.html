<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>DNS Viewer</title>
	<link rel="stylesheet" href="index.css">
</head>
<body>
	<div class="container" id="main">
		<div class="column_dev_info">
			<div class="column__title">DHCP Binding Information</div>
			<div>
				<table border="1" class="table_1">
					<tr>
						<th class="th_1">Hostname</th>
						<th class="th_1">IP</th>
						<th class="th_1">MAC</th>
						<th class="th_1">Status</th>
						<th class="th_1">Action</th>
					</tr>
					<tr v-repeat="item : fixed">
						<td class="td_1"><span class="hostname">{{item.hostname}}</span></td>
						<td class="td_1"><span class="ip">{{item.id}}</span></td>
						<td class="td_1"><span class="mac">{{item.mac}}</span></td>
						<td class="td_1" align="center"><span class="active" v-if="item.state">active</span><span class="offline" v-esle>offline</span></td>
						<td class="td_1" align="center"><button v-on="click: onDeleteClick(item)">delete</button></td>
					</tr>
				</table>
			</div>
			<hr />
			<div class="column__title">DHCP Lease Information</div>
			<table border="1" class="table_1">
				<tr>
					<th class="th_1">Hostname</th>
					<th class="th_1">IP</th>
					<th class="th_1">MAC</th>
					<th class="th_1">Lease Start</th>
					<th class="th_1">Lease End</th>
					<th class="th_1">Status</th>
					<th class="th_1">Action</th>
				</tr>
				<tr v-repeat="item : staging">
					<td class="td_1"><span class="hostname">{{item.hostname}}</span></td>
					<td class="td_1"><span class="ip">{{item.id}}</span></td>
					<td class="td_1"><span class="mac">{{item.mac}}</span></td>
					<td class="td_1" align="center"><span class="date">{{item.starts}}</span></td>
					<td class="td_1" align="center"><span class="date">{{item.ends}}</span></td>
					<td class="td_1" align="center"><span class="active" v-if="item.state">active</span><span class="offline" v-esle>offline</span></td>
					<td class="td_1" align="center"><button v-on="click: onBindClick(item)">bind</button></td>
				</tr>
			</table>
		</div>
		<div class="column_mgmt_info">
			<div class="column__title">MAC/IP Binding</div>
			<div class="column__subtitle">(admin area)</div>
			<table border="0">
				<tr>
					<td class="td_2">Hostname</td>
					<td><input name="hostname" id="hostname" placeholder="ex. name"></td>
				</tr>
				<tr>
					<td class="td_2">MAC Address</td>
					<td><input name="mac" id="mac_addr" placeholder="ex. 08:00:27:ef:9a:50"></td>
				</tr>
				<tr>
					<td class="td_2">IP Address</td>
					<td><input name="ip" id="ipv4_addr" placeholder="ex. 192.168.1.1"></td>
				</tr>
				<tr>
					<td></td>
					<td><button class="submit" v-on="click: onAddClick">submit</button></td>
				</tr>
			</table>
			<hr />
			<div class="column__title">Restart DHCP</div>
			<div class="column__subtitle">(admin area)</div>
			<div class="simple-form">
				<div class="button-center"><button class="submit" v-on="click: onRestartClick">restart</button><div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<script src="js/vue.min.js"></script>
	<script src="js/superagent.js"></script>
	<script>
		var request = window.superagent;
		function d2a(dict){
			var keys = Object.keys(dict);
			return keys.map(function(key){
				var o = dict[key];
				o.id = key;
				return o;
			});
		}
		var app = new Vue({
			el: "#main",
			data: {
				free_src : {},
				staging_src: {},
				fixed_src : {}
			},
			computed: {
				free: function(){
					return d2a(this.free_src).filter(function(item){
						return item.binding === "free";
					});
				},
				staging: function(){
					return d2a(this.staging_src);
				},
				fixed: function(){
					return d2a(this.fixed_src);
				}
			},
			ready: function(){
				this.update();
			},
			methods: {
				update: function() {
					var self = this;
					request.get("data.json", function(err, res){
						self.free_src = res.body.free;
						self.fixed_src = res.body.fixed;
						self.staging_src = res.body.staging;
					})
				},
				onAddClick: function() {
					hostname = document.querySelector('#hostname').value;
					mac = document.querySelector('#mac_addr').value;
					ipv4 = document.querySelector('#ipv4_addr').value;
					// hostname validation (RFC1123, RFC952)
					if (!hostname.match(/^(([a-zA-Z]|[a-zA-Z][a-zA-Z0-9\-\_]*[a-zA-Z0-9])\.)*([A-Za-z]|[A-Za-z][A-Za-z0-9\-\_]*[A-Za-z0-9])$/)) {
						alert("Warning: Invalid Hostname");
						return;
					}
					if (!mac.match(/([0-9a-fA-F]{2}[:]){5}([0-9a-fA-F]{2})/)) {
						alert("Warning: Invalid Mac Address");
						return;
					}
					if (!ipv4.match(/192\.168\.1[1-2][0-9]\.([1-9]?[0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])/)) {
						alert("Warning: Invalid IPv4 Address");
						return;
					}
					if (!confirm('Binding MAC/IP\nHOSTNAME: ' + hostname + '\nMAC: ' + mac + '\nIP' + ipv4 + '\nInformation Confirm')) {
						return false;
					}
					var self = this;
					request
						.post('admin/addfix')
						.type('form')
						.send({hostname: hostname, mac: mac, ip: ipv4})
						.end(function(err, res) {
							self.update();
							document.querySelector('#hostname').value = "";
							document.querySelector('#mac_addr').value = "";
							document.querySelector('#ipv4_addr').value = "";
						})
				},
				onAddClick: function(item) {
				},
				onDeleteClick: function(item) {
					if (!confirm(item.hostname + 'Do you confirm to delete this binding?')) {
						return false;
					}
					var self = this;
					request
						.post('admin/deletefix')
						.type('form')
						.send({hostname: item.hostname, mac: item.mac})
						.end(function(err, res) {
							self.update();
						})
				},
				onRestartClick: function(item) {
					if (!confirm('Restart DHCP Server')) {
						return false;
					}
					request
						.post('admin/restart')
						.end(function(err, res) {
							self.update();
						})
				},
			},
		});
	</script>
	
</body>
</html>
